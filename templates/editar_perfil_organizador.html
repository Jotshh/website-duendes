<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Perfil - Organizador</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="icon" type="image/x-icon" href="../static/assets/img/favicon.ico"/>
</head>
<body>
    {% include 'componentes/header.html' %}

    <main class="container">
        <section class="card">
            <div class="back-button-container">
                <button class="btn-voltar" type="button" onclick="history.back()">
                    ⬅ Voltar
                </button>  
            </div>

            <h2 style="margin: 0 0 20px 0">Editar Perfil - Organizador</h2>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        {% if category == 'success' %}
                            <div class="alert-success">
                                {{ message }}
                            </div>
                        {% elif category == 'error' %}
                            <div class="alert-error">
                                {{ message }}
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST">
                <div class="form-group">
                    <label for="nome">Nome/Razão Social</label>
                    <input type="text" id="nome" name="nome" value="{{ organizador.nome if organizador.nome else '' }}" required class="form-input">
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" value="{{ organizador.email if organizador.email else '' }}" required class="form-input">
                </div>

                <div class="form-group">
                    <label for="cpf_cnpj">CPF/CNPJ</label>
                    <input type="text" id="cpf_cnpj" value="{{ organizador.cpf_cnpj if organizador.cpf_cnpj else '' }}" disabled class="form-input">
                    <small style="color: #666;">CPF/CNPJ não pode ser alterado</small>
                </div>

                <div class="form-group">
                    <label for="telefone">Telefone</label>
                    <input type="tel" id="telefone" name="telefone" value="{{ organizador.telefone if organizador.telefone else '' }}" required class="form-input">
                </div>

                <!-- Alteração de senha (opcional) -->
                <div class="form-section">
                    <h3 style="color: #333; margin-bottom: 15px;">Alterar Senha (opcional)</h3>
                    
                    <div class="form-group">
                        <label for="senha_atual">Senha Atual</label>
                        <input type="password" id="senha_atual" name="senha_atual" class="form-input" placeholder="Digite sua senha atual">
                    </div>

                    <div class="form-group">
                        <label for="nova_senha">Nova Senha</label>
                        <input type="password" id="nova_senha" name="nova_senha" class="form-input" placeholder="Digite a nova senha (mínimo 6 caracteres)">
                    </div>

                    <div class="form-group">
                        <label for="confirma_senha">Confirmar Nova Senha</label>
                        <input type="password" id="confirma_senha" name="confirma_senha" class="form-input" placeholder="Confirme a nova senha">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-criar" style="padding: 12px 24px;">Salvar Alterações</button>
                    <a href="{{ url_for('perfil_organizador') if session.user_type == 'organizador' else url_for('perfil') }}" class="btn-cancelar">Cancelar</a>
                </div>
            </form>
        </section>
    </main>

    <script>
        // Máscara para telefone
        document.getElementById('telefone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 10) {
                value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
            } else if (value.length > 5) {
                value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d{0,5})/, '($1) $2');
            } else if (value.length > 0) {
                value = value.replace(/^(\d*)/, '($1');
            }
            e.target.value = value;
        });

        // Validação de senhas iguais
        document.getElementById('nova_senha').addEventListener('input', validarSenhas);
        document.getElementById('confirma_senha').addEventListener('input', validarSenhas);

        function validarSenhas() {
            const novaSenha = document.getElementById('nova_senha');
            const confirmaSenha = document.getElementById('confirma_senha');
            
            if (novaSenha.value && confirmaSenha.value) {
                if (novaSenha.value !== confirmaSenha.value) {
                    confirmaSenha.style.borderColor = '#dc3545';
                    return false;
                } else {
                    confirmaSenha.style.borderColor = '#28a745';
                    return true;
                }
            }
            return true;
        }

        // Validação do formulário
        document.querySelector('form').addEventListener('submit', function(e) {
            if (!validarSenhas()) {
                e.preventDefault();
                alert('As senhas não coincidem!');
                return;
            }
            
            const senhaAtual = document.getElementById('senha_atual').value;
            const novaSenha = document.getElementById('nova_senha').value;
            const confirmaSenha = document.getElementById('confirma_senha').value;
            
            // Se tentou alterar senha, precisa da senha atual
            if ((novaSenha || confirmaSenha) && !senhaAtual) {
                e.preventDefault();
                alert('Para alterar a senha, é necessário informar a senha atual.');
                return;
            }
            
            // Se informou uma senha, precisa da outra também
            if ((novaSenha && !confirmaSenha) || (!novaSenha && confirmaSenha)) {
                e.preventDefault();
                alert('Preencha ambos os campos de nova senha.');
                return;
            }
        });
    </script>
</body>
</html>